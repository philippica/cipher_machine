<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>焖肉面 - puzzle hunt工具集</title>
		<style>
			.capsule{
				background-color: #9eddff;
				width: 100%;
				height: 20px;
				border-radius: 10px;
				text-align: center;
				margin:2px;
				cursor: pointer;
				margin: 5px;
			}
			.flag-shape {
                margin: 10px;
                width: 0;
                height: 0;
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-bottom: 30px solid #000000;
			}
			.transparent {
				opacity: .1;
			}
			.capsule:hover{
				font-weight: bold;
				-webkit-transform: translateX(-3px);
				transform: translateX(-3px);
				transition: .5s ease;
			}
			.content-area {
				height: fit-content;
			}
			.container {
				width: 50%;
			}
			.content-area textarea {
				background-color: #f8f8f8;
  				font-size: 16px;
				margin: 10px;
			}
			.help-content {
				font-size: 12px;
    			color: #adabab;
				background-color: "unset";
			}
			#word-search-content {
				width: 40%;
				height: 400px;
			}
			.word-content {
				width: 80%;
				display: flex;
				flex-wrap: wrap;
				word-break: break-word;
			}
			#word-find-similarity-hint {
				margin-top: 30px;
			}
			.word-content > div{
				margin: 5px
			}
			.word-content > b{
				flex-basis: 100%;
				font-size: 20px;
			}
			#footer, h1, h3 {
				margin: 40px;
				display: flex;
				justify-content: space-around;
			}
			.face-container {
				width: fit-content;
				display: flex;
				width: 100%;
				justify-content: space-around;
			}
			#expand {
				width: fit-content;
				margin: 10px;
			}
			.face {
				height: 200px;
				width: 200px;

			}
			.cube-block {
				background-color: gray;
				vertical-align: bottom;
				border: 1px solid;
			}
			#rubik-cube{
				border: 5px solid;
			}
			#piano {
				display: flex;
			}
			.pianoWhiteKey {
				width: 25px;
				height: 120px;
				border: 1px solid;
				margin-right: -1px;
				display: flex;
				flex-direction: column;
				justify-content: flex-end;
			}
			.pianoBlackArea{
				position: absolute;
				display: flex;
				margin-left: 15px;
			}
			.pianoBlackKey {
				width: 20px;
				height: 80px;
				display: flex;
				flex-direction: column;
				justify-content: flex-end;
				border: 1px solid;
				background-color: black;
				color: white;
			}
			.blind-dot {
				border-radius: 50%;
				width: 30px;
				height: 30px;
				border: 1px solid;
				margin: 10px 2px 2px 10px;
			}
			#blind-letter, #flag-letter{
				font-size: 20px;
				margin-left: 40px;
				margin-top: 20px;
			}
			.map-unit {
				width: 25px;
			}
			.map-unit input{
				width: 22px;
				background-color: #80808036;
			}
			.map-unit div {
				margin-left: 4px;
			}
			.sudoku-grid {
				width: 30px;
				height: 30px;
				border: 2px solid;
				margin-right: -1px;
				margin-bottom: -1px;
			}
			#sudokuContainer {
				display: flex;
				flex-wrap: wrap;
				align-content: flex-start;
			}
			.sudoku-grid-content {
				height: 26px;
				width: 26px;
				margin: 1px;
				text-align: center;
			}
			.sudoku-index {
				z-index: -1;
				font-size: 12;
				opacity: 0.2;
				position: absolute;
			}

			#view, #files {
				margin: 30px;
			}
			
			.line {
				width: 0px;
				border: 1px solid;
				height: 100%;
				background-color: black;
				position: absolute;
				cursor: pointer
			}
			#wave{
				position: absolute;
				width: 100%;
				height: 100%;
				z-index:-2;
			}
			#waveContainer {
				height: 200px;
				width: 1000px;
			}
			#frequency {
				height: 500px;
				width: 16380px;
				vertical-align: bottom;
				display: flex;
				flex-wrap: wrap;
				justify-content: flex-start;
				align-content: stretch;
				align-items: flex-end;
			}
			#selectedArea {
				height: 100%;
				position: absolute;
				background-color: gray;
				width: inherit;
				margin-left: 2px;
				z-index:-1;
        		opacity: 0.3;
			}
			.bar {
				width: 0px;
				border-left: 1px solid;
				transition: height .5s;
			}
			.noteTooltip {
				position: relative;
				display: inline-block;
				cursor: pointer;
			}
			.tooltiptext {
				visibility: hidden;
				width: 120px;
				background-color: black;
				color: #fff;
				text-align: center;
				padding: 5px 0;
				border-radius: 6px;
				position: absolute;
				z-index: 1;
			}

			.noteTooltip:hover .tooltiptext {
				visibility: visible;
			}
			.form-control {
				font-family: monospace, monospace;
			}
			#plain-code-area {
				font-size: x-large;
				margin: 40px;
			}
			#sudoku-upper .col-input {
				width: 30px;
			}
			#sudoku-upper {
				margin-bottom: 10px;
				margin-right: 0px !important;
			}
			#sudoku-left .row-input {
				height: 30px;
				margin-left: -1px !important;

			}
			#sudoku-left {
				margin-right: 10px !important;
			}
			#smart-analysis-ansers {
				min-height: 100px;
				border: 1px solid;
			}
			.analysis-hint {
				color: grey;
    			font-size: smaller;
			}
			.analysis-bar {
				margin-left: 30px;
			}
			.sudoku-grid-content {
			position: relative;
			}

			.sudoku-grid-content:before, .sudoku-grid-content:after {
			content: "";
			position: absolute;
			z-index: 10;
			background: black;
			}

			.UL:before, .UR:before{
			left: 50%;
			width: 10%;
			margin-left: -5%;
			height: 55%;
			}

			.UL:after, .BL:after {
			top: 50%;
			left: 0%;
			height: 10%;
			margin-top: -5%;
			width: 55%;
			}

			.RL:after {
				top: 50%;
				left: 0%;
				height: 10%;
				margin-top: -5%;
				width: 100%;
			}

			.UB:before {
				left: 50%;
				width: 10%;
				margin-left: -5%;
				top: 0%;
				height: 100%;
			}

			.RB:before, .BL:before {
			left: 50%;
			width: 10%;
			margin-left: -5%;
			top: 50%;
			height: 55%;
			}

			.RB:after, .UR:after {
			top: 50%;
			left: 45%;
			height: 10%;
			margin-top: -5%;
			width: 55%;
			}
			.horizon- {
				width: 100%;
				height: 1px;
				background-color: black;
				position: absolute;
				z-index: 10;
				border: 1px solid;
			}
			.vertical- {
				width: 1px;
				height: 100%;
				background-color: black;
				position: absolute;
				z-index: 10;
				border: 1px solid;
			}
 		</style>
		<link rel="stylesheet" href="./static/nonogram.css">
		<link rel="stylesheet" href="./static/bootstrap.min.css">
	</head>
	<body>
		<h1>焖肉面- puzzle hunt工具集</h1>
		<h3>正在加载所需要的资源，暂时功能不可用,请稍等片刻，如果实在太慢，可下载本页面到电脑本地使用</h3>
		<div style="text-align: center;">
			常用链接:
			<a href="https://philippica.github.io/cipher_machine/cipher_sheet">常用密码表</a>
			<a href="https://www.quinapalus.com/cgi-bin/qat">QAT(非常强大的查词工具)</a>
			<a href="https://nutrimatic.org/">NUTRI(词组暴力工具)</a>
			<a href="https://www.quipqiup.com/">QUIPQIUP(自动单表暴力工具)</a>
			<a href="https://www.wordplays.com/crossword-solver">Crossword线索查询网站</a>
			<a href="https://nova.astrometry.net/">通过星空照片就能找到星座以及拍摄位置的网站</a>
		</div>
		<div class="container">
			<div id="word-container">
				<div id="word-capsule" class="capsule" data-expend=true>puzzle 字典(正则匹配、anagram、通配符、编辑距离)</div>
				<div id="word-main" class="content-area">
					<fieldset>
						<legend>选择需要筛选的类别</legend>
						<div>
							<input type="checkbox" id="all" name="all" checked>
							<label for="all">全选</label>
						</div>
						<div>
						  <input type="checkbox" id="noun" name="noun" checked>
						  <label for="noun">名词</label>
						</div>
						<div>
							<input type="checkbox" id="verb" name="verb" checked>
							<label for="verb">动词</label>
						</div>
						<div>
							<input type="checkbox" id="adj" name="adj" checked>
							<label for="adj">形容词</label>
						</div>
						<div>
							<input type="checkbox" id="adv" name="adv" checked>
							<label for="adv">副词</label>
						</div>
						<div>
							<input type="checkbox" id="lowfrequcy" name="lowfrequcy" checked>
							<label for="lowfrequcy">低频词</label>
						</div>
					</fieldset>
					<textarea id="one-word-content" class="form-control" placeholder="请输入要查询的单词"></textarea>
					<div id="method-select">
						<select onchange="changeMethod()" id="find-method">
							<option value ="findByWildcard">通配符</option>
							<option value ="findByRegularExpression">正则</option>
							<option value ="contains">包含</option>
							<option value ="findSimilarity">寻找相似单词(编辑距离)</option>
							<option value ="findByCode">DIY写程序查找</option>
						</select>
						<div id="twoWordContainer"><span>两个词</span><input type="checkbox" id="twoWords" /></div>
					</div>
					<pre id="help-content" class="help-content"></pre>
					<button id="find-words">solve</button>
					<div>以下为可能结果:</div>
					<div id="word-list-count"></div>
					<div id="words-list"></div>
				</div>
			</div>
			<div id="substitution-container">
				<div id="substitution-capsule" class="capsule" data-expend=true>单表替换</div>
				<div id="substitution-main" class="content-area" style="display: none;">
					<form role="form">
						<div class="form-group">
							<div>单表暴力</div>
							<textarea id="content" class="form-control" rows="20" placeholder="请输入单表密文"></textarea>
							<div>
								<button id="substitution-solver-btn" type="button">单表暴力</button>
							</div>
						</div>
					</form>
					<div>以下为可能结果:</div>
					<div id="substitution-answer"></div>
				</div>
			</div>
			<div id="word-search-container">
				<div id="word-search-capsule" class="capsule" data-expend=true>Word Search</div>
				<div id="word-search-main" class="content-area" style="display: none;">
					<div class="help-content">Word Search是一个找词游戏，给出一个n*m的字母方阵，要求在横竖斜的方向上找到英语单词</div>
					<div class="help-content">在下面文本框内填入要word search的字母方阵，例如</div>
					<div class="help-content">abc</div>
					<div class="help-content">ddf</div>
					<div class="help-content">ghi</div>
					<div>
						<textarea id="word-search-content" class="form-control" placeholder="请输出字母方阵,用空行隔开"></textarea>
						<button onclick="wordSearch()">Solver</button>
					</div>
					<div id="word-search-ansers" style="display: flex">
						<div id="word-search-ansers-list"></div>
						<div id="word-search-ansers-position" style="margin-left: 40px"></div>
					</div>
				</div>
			</div>
			<div id="smart-analysis-container">
				<div id="smart-analysis-capsule" class="capsule" data-expend="true">密文智能分析</div>
				<div id="rubik-cube-main" class="content-area" style="display:none">
					<div class="help-content">请在下面文本框内输入要分析的文本, 逗号或者空格可以作为分隔符</div>
					<div>
						<textarea id="smart-analysis-content" class="form-control" rows="1" placeholder="请输出要分析的文本"></textarea>
					</div>
					<div id="smart-analysis-ansers" style="display:flex; font: 15px monospace;">
						<div id="smart-analysis-ansers-list"></div>
						<div id="smart-analysis-ansers-position" style="margin-left:40px"></div>
					</div>
				</div>
			</div>
			<div id="rubik-cube-container">
				<div id="rubik-cube-capsule" class="capsule" data-expend=true>魔方</div>
				<div id="rubik-cube-main" class="content-area" style="display: none;">
					<div class="help-content">请拖动魔方观看所有面:</div>
					<canvas id="rubik-cube" height="300px" width="300px"></canvas>
					<button onclick="resetRubicCube()">重置魔方</button>
					<div>
						<div>顺时针</div>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' F');window.rubicCube.front(1)">前面(F)</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' U');window.rubicCube.up(1)">顶面(U)</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' B');window.rubicCube.back(-1)">背面(B)</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' D');window.rubicCube.bottom(-1)">底面(D)</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' L');window.rubicCube.left(1)">左边(L)</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' R');window.rubicCube.right(-1)">右面(R)</button>
					</div>
					<div>
						<div>逆时针</div>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' F\'');window.rubicCube.front(-1)">前面(F')</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' U\'');window.rubicCube.up(-1)">顶面(U')</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' B\'');window.rubicCube.back(1)">背面(B')</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' D\'');window.rubicCube.bottom(1)">底面(D')</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' L\'');window.rubicCube.left(-1)">左边(L')</button>
						<button onclick="$('#rubic-formular').html($('#rubic-formular').html() + ' R\'');window.rubicCube.right(1)">右面(R')</button>
					</div>
					<br/>
					<b id="rubic-formular">公式 :</b>
					<br/>
					<div class="help-content">在下面魔方展开图中可用鼠标绘制任意图案颜色(注:画笔颜色既可以是颜色英文，例如red, blue, orange, 也可是#开头的RGB,例如#FFABCD)</div>
					<label>画笔颜色</label><input id="penColor" value="black"/>
					<label>画笔粗细</label><input id="penWidth" value="3"/>
					<div id="expand"></div>
				</div>
			</div>
			<div id="music-container">
				<div id="music-capsule" class="capsule" data-expend=true>音乐</div>
				<div id="music-main" class="content-area" style="display: none;">
					<div id="piano">
						<div onclick="playSound(130.81, 2000)" class="pianoWhiteKey">C3</div>
						<div onclick="playSound(146.83, 2000)" class="pianoWhiteKey">D3</div>
						<div onclick="playSound(164.81, 2000)" class="pianoWhiteKey">E3</div>
						<div onclick="playSound(174.61, 2000)" class="pianoWhiteKey">F3</div>
						<div onclick="playSound(196.00, 2000)" class="pianoWhiteKey">G3</div>
						<div onclick="playSound(220, 2000)" class="pianoWhiteKey">A3</div>
						<div onclick="playSound(246.94, 2000)" class="pianoWhiteKey">B3</div>
						<div onclick="playSound(261.63, 2000)" class="pianoWhiteKey">C4</div>
						<div onclick="playSound(293.66, 2000)" class="pianoWhiteKey">D4</div>
						<div onclick="playSound(329.63, 2000)" class="pianoWhiteKey">E4</div>
						<div onclick="playSound(349.23, 2000)" class="pianoWhiteKey">F4</div>
						<div onclick="playSound(392.00, 2000)" class="pianoWhiteKey">G4</div>
						<div onclick="playSound(440, 2000)" class="pianoWhiteKey">A4</div>
						<div onclick="playSound(493.88, 2000)" class="pianoWhiteKey">B4</div>
						<div class="pianoBlackArea">
							<div class="pianoBlackKey">C#</div>
							<div class="pianoBlackKey">D#</div>
						</div>
					</div>
				</div>
			</div>
			<div id="blind-container">
				<div id="blind-capsule" class="capsule" data-expend=true>盲文&旗语</div>
				<div id="blind-main" class="content-area" style="display: none;">
					<div>盲文:</div>
					<div id="demo-blind-letter" style="margin-right: 5px;">
						<div style="display: flex;">
							<div>
								<div class="blind-dot" data-index=0 ></div>
								<div class="blind-dot" data-index=1 ></div>
								<div class="blind-dot" data-index=2 ></div>
							</div>
							<div>
								<div class="blind-dot" data-index=3 ></div>
								<div class="blind-dot" data-index=4 ></div>
								<div class="blind-dot" data-index=5 ></div>
							</div>
						</div>
						<div id="blind-letter"></div>
					</div>
					<button onclick="confirmBlind()" style="margin: 20px;">确认</button>
					<div id="history-blind-area" style="display: flex;"></div>
					<div >旗语:</div>
					<div id="demo-flag">
						<div style="display: flex;">
							<div class="flag-shape " style="transform: rotate(-45deg);" data-index=0></div>
							<div class="flag-shape" data-index=1></div>
							<div class="flag-shape transparent" style="transform: rotate(45deg);" data-index=2></div>
						</div>
						<div style="display: flex;">
							<div class="flag-shape transparent" style="transform: rotate(-90deg);" data-index=3></div>
							<div style="width: 40px; height: 50px;" ></div>
							<div class="flag-shape transparent" style="transform: rotate(90deg);" data-index=4></div>
						</div>
						<div style="display: flex;">
							<div class="flag-shape transparent" style="transform: rotate(-135deg);" data-index=5></div>
							<div class="flag-shape transparent" style="transform: rotate(180deg);" data-index=6></div>
							<div class="flag-shape transparent" style="transform: rotate(135deg);" data-index=7></div>
						</div>
						<div id="flag-letter"></div>
					</div>
					<button onclick="confirmFlag()" style="margin: 20px;">确认</button>
					<div id="history-flag-area" style="display: flex;"></div>
				</div>
			</div>
			<div id="cipher-container">
				<div id="cipher-capsule" class="capsule" data-expend=true>古典密码</div>
				<div id="cipher-main" class="content-area" style="display: none;">
					<div id="cipher-tools">
						<button id="caeser-brute-force" style="margin: 20px;">暴力凯撒</button>
						<button id="QWE" style="margin: 20px;">QWE</button>
						<hr/>
						<div id="general-substitute-cipher">
							<select onchange="changeSubstitutionMethod()" id="substitution-cipher-method">
								<option value ="QWECipher">字母序(a = 1, b = 2)</option>
								<option value ="QWECipher">字母序(a = 01, b = 02)</option>
								<option value ="QWECipher">QWE</option>
								<option value ="QWECipher">Atbash</option>
								<option value ="QWECipher">5*5棋盘(i/j同格)</option>
								<option value ="QWECipher">手机键盘</option>
								<option value ="QWECipher">莫尔斯电码(morse code)</option>
								<option value ="QWECipher">元素周期表</option>
							</select>
							<textarea id="key-textarea" class="form-control" rows="4" oninput="onTypeKey()"></textarea>
							<button onclick="encode()">编码</button>
							<button onclick="decode()">解码</button>
						</div>
						<div style="margin: 10px;">将<input id="replace1"/> 替换成 <input id="replace2"/> <button onclick="replaceStr()">替换</button></div>
						<button onclick="removeSpace()">去空格</button>
						<div><input id="spaceCnt" value = "2" style="width: 40px;"/>个一组<button onclick="addSpace()">加空格</button></div>
					</div>
					<textarea id="cipher-code-textarea" class="form-control" rows="20" placeholder="请输入密文" oninput="onTypePlainCode()"></textarea>
					<div id="plain-code-area"></div>
				</div>
			</div>
			<div id="sudoku-container">
				<div id="sudoku-capsule" class="capsule" data-expend=true>数独、幻方、扫雷、nonogram、Drop Quote黑科技</div>
				<div id="sudoku-main" class="content-area" style="display: none;">
					<div>
						<select id ="solverMode" onchange="changeSolverMode()">
							<option value ="sudoku">经典数独模式</option>
							<option value ="mine">经典扫雷</option>
							<option value = "magicSquare">经典幻方</option>
							<option value = "nonogram">经典nonogram</option>
							<option value = "drop">经典drop</option>
							<option value = "simpLoop">经典simple loop</option>
							<option value = "hashi">经典hashi</option>
						</select>
					</div>
					<span>行: </span> <span id="sudoku-row" style="border: 1px solid;" contenteditable="true">9</span>
					<span>列: </span> <span id="sudoku-col" style="border: 1px solid;" contenteditable="true">9</span>
					<a href="https://github.com/philippica/cipher_machine/wiki/%E7%84%96%E8%82%89%E9%9D%A2%E8%84%9A%E6%9C%AC%E6%96%87%E6%A1%A3">脚本规则说明</a>
					<div><span>显示上排</span><input type="checkbox" id="show-upper" /></div>
					<div><span>显示左排</span><input type="checkbox" id="show-left" /></div>
					<button id="dropHelper" style="display: none;">一键生成drop成单词的规则(按黑格隔开成单词)</button>
					<div style="display:flex;">
						<textarea id="rules" cols="50" rows="30"></textarea>
						<div style="margin:20px;">
							<div style="display: none;" id="upperRules">
								<div style="font-size: 13px;">上排区域中的内容将被替换为规则:</div>
								<textarea id="upReplaceStr" cols="50"></textarea>
							</div>
							<div style="display: none;" id="leftRules">
								<div style="font-size: 13px;">左排区域中的内容将被替换为规则:</div>
								<textarea id="leftReplaceStr" cols="50"></textarea>
							</div>
							<div>
								<div style="font-size: 13px;">下面格子中的内容将被替换为规则:</div>
								<textarea id="replaceStr" cols="50"></textarea>
							</div>
							<div id="showcase" style="width: fit-content;">
								<div id="sudoku-upper"></div>
								<div style="display: flex;">
									<div id="sudoku-left"></div>
									<div id="sudokuContainer"></div>
								</div>
							</div>
							<pre id="sudokuAnswer"></pre>
						</div>
					</div>
					<button id="solveSudoku">solve</button>
				</div>
			</div>
			<div id="audio-container">
				<div id="audio-capsule" class="capsule" data-expend=true>音频文件(当你没有安装音频处理软件时)</div>
				<div id="audio-main" class="content-area" style="display: none;">
					<input id="files" type="file" id="files" name="files[]" multiple />
					<input type="radio" name="linesType" id="singleLine" onchange="changeLineType()"checked>只显示一条竖线(用于分析频率时用)
					<input type="radio" name="linesType" id="doubleLine" onchange="changeLineType()">显示起始和结束两条线(用于播放)
					<div style="height: 200px;">
						<div id="waveContainer" style="position: absolute">
							<canvas id="wave"></canvas>
							<div id="start" class="line"></div>
							<div id="selectedArea" style="display: none;"></div>
							<div id="end" class="line" style="left: 100%; display: none;"></div>
						</div>
					</div>
					<button id="play">▶</button>
					<button onclick="analysis()">analysis</button>
					<div id="frequency"></div>
					<div id="noteOutput"></div>
				</div>
			</div>
		</div>
		<div id="footer"> power by -- philippica (Contact me: philippicapyj@gmail.com)</div>
		<script src="<%= htmlWebpackPlugin.files.js[0] %>"></script>
		<script src="./static/jquery.min.js"></script>
		<script>
			$('h3').text("字典尚在加载,部分利用到字典的功能暂不可用,请稍等片刻,如果实在太慢,可下载本页面到电脑本地使用");
			if(localStorage.abc) {
				window.words = {};
				for (let i = 0, len = localStorage.length; i < len; i++) {
					const key = localStorage.key(i);
					words[key] = localStorage.getItem(key).split(",");
				}
				$('h3').remove();
			}
			// substitution
			$(".capsule").click((e) => {
				const target = e.target;
				const content = $(target.parentElement.lastElementChild);
				if(content.is(":visible")) {
					content.hide("fast", "linear");
				} else {
					content.show("fast", "linear");
				}
			});


			let rubicCubeMaterias;

			$("#rubik-cube-capsule").click((e) => {
				if(!window.rubicCube) {
					const materias = initExpand();
					rubicCubeMaterias = materias
					const rubikCanvas = document.getElementById('rubik-cube'),
					rubikCtx = rubikCanvas.getContext('2d');
					window.rubicCube = new Solver.RubikCubeStage(rubikCtx, rubikCanvas.width, rubikCanvas.height, rubicCubeMaterias);
				}
			});

			$("#substitution-solver-btn").click(function(){
				var content = $("#content").val();
				console.info(content);
				plaintext = new Solver.SubstitutionSolver().substituteSolver(content)
				$("#substitution-answer").empty();
				if(plaintext.length === 0) {

				}
				for(let i = 0; i < Math.min(plaintext.length, 100); i++) {
					$("#substitution-answer").append(`<div><b>${plaintext[i]}</b></div>`);
				}
			});

			// one word
			let solver = new Solver.OneWord();
			const oneWordHelpContent = {
				"findByWildcard": "当前是通配符模式 - 你可以使用#表示一个字母或者*表示多个字母 例如 bo##ke*r 可以匹配到bookkeeper",
				"findByRegularExpression": "当前是正则表达式模式 - 如果你熟悉正则表达式，那它将会是一个非常强大的工具 例如^[abcd][ef].*[aeiou]$ 能够搜到第一个字母为abcd中一个，第二个字母为ef中一个，并且以元音结尾的所有单词\n\n例如寻找第一个字符和第四个字符相同第二个字符为b的长度为8的单词 ^(.)b.\\1....$ 解释：(其中\\1表示从左到右第一个括号需要和它相同 .代表任意字符 ^ $分别代表头和尾)\n\n例如寻找长度为4的第一个字符和第四个字符相同，第二个字符和第三个字符相同的单词: ^(.)(.)\\2\\1$\n\n例如寻找第一个字符是元音，且第一个字符和第三个字符相同，长度不定，第二个字符不可能是b或者c的单词 ^([aeiou])[^bc]\\1\n",
				"contains": "当前是包含模式 - 能够搜出所有至少包含这些字母的单词，例如abbcc会找到所有至少包含一个a两个b和两个c的单词",
				"findSimilarity": "当前是相似度模式-给出单词找到与它相想的单词，两个词相似度即编辑距离，如果能通过一次添加一个字母，替换一个字母或删除一个字母能从一个单词变成另一个单词，那它们的相似度为1",
				"findByCode": "最灵活的找词方式，通过自己编写js代码，实现一个接受一个字符串作为参数的check函数来寻找单词\n函数同时会传入一个tool的参数，包含很多有用函数，当前包括:\n\tisWord(str: string) :bool : 判断传入字符串是否为英语单词\n\tanagram(str: string, letters: string) :bool : 判断传入字符串是否为letters参数中的字符排列组成"
			};
			let method = "findByWildcard";
			$("#help-content").text(oneWordHelpContent[method]);
			const changeMethod = () => {
				const methodStr = $("#find-method").val()
				method = methodStr;
				$('#word-find-similarity-hint').remove();
				$('#similarityRegex').remove();
				$("#similarityDegree").remove();
				$("#twoWordContainer").remove();
				$("#one-word-content").height(60);
				if(method === "findSimilarity") {
					$("#method-select").append("<input id='similarityDegree' placeholder='相似度' value='1'/>");
					$("#method-select").append("<div id='word-find-similarity-hint'>在结果中用正则查找:</div><input id='similarityRegex' placeholder='正则表达式(不填则输出所有结果)' />");
				} else if(method === 'contains') {
					$("#method-select").append("<div id='word-find-similarity-hint'>在结果中用正则查找:</div><input id='similarityRegex' placeholder='正则表达式(不填则输出所有结果)' />");
				} else if(method === "findByCode") {
					$("#one-word-content").val('function check(str, tools) {\n\tif(str[0]!=str[str.length-1])return null; // 如果首字母和尾字母不相等，不选这个单词\n\tif(str.length > 7 || str.length < 5)return null; // 如果单词长度大于7或者小于2，不选这个单词\n\tif(/^a.*b$/.test(str))return null;// 如果满足正则^a.*b$ 不选这个单词\n\tif(tools.anagram(str.substr(2,3), "guo") === false)return null; // 如果从第3个字符起往后3个字母不是由abc组成的，不选这个单词\n\tif(tools.isWord(str.substr(2,5)) === true){ // 如果单词第3个字符（因为下标从0开始)往后5个字母是一个英语单词\n\t\treturn str + " " + str.substr(2,5); //输出该词，并把第三个到第5个字母的字串放后面\n\t}\n}');
					$("#one-word-content").height(400);
				} else if(method === "findByWildcard") {
					$("#method-select").append(`<div id="twoWordContainer"><span>两个词</span><input type="checkbox" id="twoWords" /></div>`);
				}
				$("#help-content").text(oneWordHelpContent[method]);
			}
			$("#find-words").click(async function(){
				let content = $("#one-word-content").val();
				let answer;
				$("#words-list").empty();
				if(method !== "contains") {
					for(let i = 20; i >= 1; i--) {
					 	$("#words-list").append(`<div id="len-${i}" style="display: none;" class="word-content"><b style="display: block">长度为${i}:</b></div>`);
					}
				} else {
					for(let i = 1; i <= 20; i++) {
					 	$("#words-list").append(`<div id="len-${i}" style="display: none;" class="word-content"><b style="display: block">长度为${i}:</b></div>`);
					}
				}
				let count = 0;
				const findWord = async (wordLength, word) => {
					function sleep(ms) {
						return new Promise(resolve => setTimeout(resolve, ms));
					}
					const target = $(`#words-list #len-${wordLength}`);
					if(!target.is(":visible")) {
						target.show("fast", "linear");
					}
					target.append(`<div>${word}</div>`);
					count++;
					$('#word-list-count').html(`共${count}个`);
					if(count % 1000 === 0) {
						await sleep(1);
					}
				}
				let filter = 0;
				if($("#noun").is(':checked')) filter |= 1;
				if($("#verb").is(':checked')) filter |= 2;
				if($("#adj").is(':checked')) filter |= 4;
				if($("#adv").is(':checked')) filter |= 8;
				if($("#lowfrequcy").is(':checked')) filter |= 16;

				const solverFunc = new Solver.OneWord()[method].bind(solver);
				if(method === "findSimilarity") {
					const regex = $('#similarityRegex').val();
					let regularExpression;
					if(regex && regex !== '') {
						regularExpression = eval(`/${regex}/`);
					}
					findSimilarity = async (wordLength, word) => {
						if(regularExpression && !regularExpression.test(word)) {
							return;
						}
						await findWord(wordLength, word);
					}
					const similarityDegree = parseInt($("#similarityDegree").val());
					answer = await solverFunc(content, similarityDegree, findSimilarity, filter)
				} else if(method === 'contains') {
					const regex = $('#similarityRegex').val();
					let regularExpression;
					if(regex && regex !== '') {
						regularExpression = eval(`/${regex}/`);
					}
					findSimilarity = async (wordLength, word) => {
						if(regularExpression && !regularExpression.test(word)) {
							return;
						}
						await findWord(wordLength, word);
					}
					answer = await solverFunc(content, findSimilarity, filter)
				} else if(method === 'findByWildcard') {
					const twoWords = $("#twoWords").is(':checked');
					answer = await solverFunc(content, findWord, filter, twoWords);
				} else {
					answer = await solverFunc(content, findWord, filter)
				}
			});

			// word search
			wordSearch = () => {
				var content = $("#word-search-content").val();
				console.info(content);
				const mat = new Solver.WordSearch().buildMatrix(content);
				const answers = new Solver.WordSearch().wordSearch(mat);
				answers.sort((a, b) => b.word.length - a.word.length);
				for(let answer of answers) {
					let dirFirst = "";
					let dirSecond = "";
					if(answer.dy === 1) {
						dirFirst = "右";
					} else if(answer.dy === -1) {
						dirFirst = "左";
					}
					if(answer.dx === 1) {
						dirSecond = "下";
					} else if(answer.dx === -1) {
						dirSecond = "上";
					}
					$("#word-search-ansers-list").append(`<div>${answer.word}</div>`);
					$("#word-search-ansers-position").append(
						`<div>出现在第${answer.x+1}行，第${answer.y+1}列，向${dirFirst}${dirSecond}方向</div>`
					);
				}
			}

			// rubik cube
			initExpand = () => {
				const blocks = [];
				for(let i = 0; i < 4; i++) {
					$('#expand').append(`<div id="expand-${i}" class="face-container"></div>`);
				}
				$('#expand-0').append(`<div id="face-${0}" class="face"></div>`);
				$('#expand-1').append(`<div id="face-${1}" class="face"></div>`);
				$('#expand-1').append(`<div id="face-${2}" class="face"></div>`);
				$('#expand-1').append(`<div id="face-${3}" class="face"></div>`);
				$('#expand-2').append(`<div id="face-${4}" class="face"></div>`);
				$('#expand-3').append(`<div id="face-${5}" class="face"></div>`);
				const width = Math.floor($('#face-1').width() / 3-4);
				const height = Math.floor($('#face-1').height() / 3-4);
				const blockNum = 9;
				const colors = ["white", "green", "red", "blue", "yellow", "orange"]
				for(let i = 0; i < 6; i++) {
					for(let j = 0; j < blockNum; j++) {
						$(`#face-${i}`).append(`<canvas id="block-${i*blockNum+j}" width="${width}px" height="${height}px" class="cube-block"></canvas>`);
						let canvas = document.getElementById(`block-${i*blockNum+j}`);
						let ctx=canvas.getContext("2d");
						ctx.fillStyle=colors[i];
						ctx.fillRect(0,0,width,height);
						const index = i*blockNum+j;
						ctx.fillStyle="black";
						ctx.font="20px Georgia";
						ctx.fillText (index.toString(), 20,20);
						blocks.push(canvas);
					}
				}
				return blocks;
			}
			resetRubicCube = () => {
				$('#rubic-formular').html('公式: ')
				const rubikCanvas = document.getElementById('rubik-cube'),
				rubikCtx = rubikCanvas.getContext('2d');
				window.rubicCube = new Solver.RubikCubeStage(rubikCtx, rubikCanvas.width, rubikCanvas.height, rubicCubeMaterias);
			}

			//music
			const playSound = (frequency, timeInMillisecont) => {
				const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
				// create Oscillator node
				const oscillator = audioCtx.createOscillator();
				oscillator.type = 'sine';
				oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime); // value in hertz
				oscillator.connect(audioCtx.destination);
				oscillator.start();
				setTimeout(()=>{
					oscillator.stop();
				}, timeInMillisecont);
			}

			// blind
			const currentBlindState = [0,0,0,0,0,0];
			const braille = [];
			braille[1] = 'a';braille[3] = 'b';
			braille[9] = 'c';braille[25] = 'd';
			braille[17] = 'e';braille[11] = 'f';
			braille[27] = 'g';braille[19] = 'h';
			braille[10] = 'i';braille[26] = 'j';
			braille[5] = 'k';braille[7] = 'l';
			braille[13] = 'm';braille[29] = 'n';
			braille[21] = 'o';braille[15] = 'p';
			braille[31] = 'q';braille[23] = 'r';
			braille[14] = 's';braille[30] = 't';
			braille[37] = 'u';braille[39] = 'v';
			braille[58] = 'w';braille[45] = 'x';
			braille[61] = 'y';braille[53] = 'z';


			$('.blind-dot').on("click",function(e)
			{
				const idx = parseInt(e.target.dataset.index);
				if(currentBlindState[idx]) {
					e.target.style.backgroundColor=""
				} else {
					e.target.style.backgroundColor="black"
				}
				currentBlindState[idx] ^= 1;

				let code = 0;
				for(let i = 0; i < 6; i++) {
					code += currentBlindState[i] * (1<<i);
				}
				if(braille[code]) {
					$("#blind-letter").text(braille[code]);
				} else {
					$("#blind-letter").text("Unknown");
				}
			});

			const confirmBlind = () => {
				$("#history-blind-area").append($("#demo-blind-letter").clone());
			}
			const confirmFlag = () => {
				$("#history-flag-area").append($("#demo-flag").clone());
			}

			const flagState = [0, 1];
			const flagMap = [];
			flagMap[51] = 'a';flagMap[33] = 'b';
			flagMap[6] = 'c';flagMap[15] = 'd';
			flagMap[24] = 'e';flagMap[42] = 'f';
			flagMap[61] = 'g';flagMap[32] = 'h';
			flagMap[5] = 'i';flagMap[13] = 'j';
			flagMap[14] = 'k';flagMap[23] = 'l';
			flagMap[41] = 'm';flagMap[52] = 'n';
			flagMap[3] = 'o';flagMap[12] = 'p';
			flagMap[21] = 'q';flagMap[31] = 'r';
			flagMap[34] = 's';flagMap[1] = 't';
			flagMap[2] = 'u';flagMap[16] = 'v';
			flagMap[22] = 'w';flagMap[25] = 'x';
			flagMap[4] = 'y';flagMap[43] = 'z';

			$('.flag-shape').on("click",function(e)
			{
				const idx = parseInt(e.target.dataset.index);
				if(flagState[0] === idx || flagState[1] === idx)return;
				e.target.style.opacity=1;
				$(`.flag-shape[data-index=${flagState[0]}]`)[0].style.opacity=0.1;
				flagState[0] = flagState[1];
				flagState[1] = idx;

				const code = Math.min(flagState[0], flagState[1])*9 + Math.max(flagState[0], flagState[1]);
				console.info(code);
				if(flagMap[code]) {
					$("#flag-letter").text(flagMap[code]);
				} else {
					$("#flag-letter").text("Unknown");
				}
			});

			// classic Code

			const caeser = (str, offset) => {
				let ans = "";
				for(let ch of str) {
					let base;
					if(ch.charCodeAt() >= 65 && ch.charCodeAt() <= 90) {
						base = 65;
					} else if (ch.charCodeAt() >= 97 && ch.charCodeAt() <= 122) {
						base = 97;
					} else {
						ans += ch;
					}
					ans += String.fromCharCode((ch.charCodeAt() - base + offset) % 26 + base);
				}
				return ans;
			}

			const removeSpace = () => {
				const cipherCode = $("#cipher-code-textarea").val();
				$("#cipher-code-textarea").val(cipherCode.replaceAll(" ", ''));
			}

			const addSpace = () => {
				const chunk =(str, n)=> {
					var ret = [];
					var i;
					var len;

					for(i = 0, len = str.length; i < len; i += n) {
						ret.push(str.substr(i, n))
					}
					return ret
				};
				const cipherCode = $("#cipher-code-textarea").val();
				const count = parseInt($('#spaceCnt').val());
				$("#cipher-code-textarea").val(chunk(cipherCode, count).reduce((x, y)=>x+' '+y));

			}

			const caeserProcess = () => {
				const cipherCode = $("#cipher-code-textarea").val();
				$('#plain-code-area').empty();
				for(let i = 1; i <= 25; i++) {
					const pt = caeser(cipherCode, i)
					$('#plain-code-area').append(`<div style="display:flex;"><div>凯撒${i}： </div><div>${pt}</div></div>`);
				}
			}

			const makeMap = (mapList) => {
				const ret = {};
				for(let i = 0; i < 26; i++) {
					ret[String.fromCharCode(i+97)] = mapList[i];
				}
				return ret;
			} 


			$('#caeser-brute-force').on("click",function(e)
			{
				caeserProcess();
			});

			const replaceStr = () => {
				const cipherText = $('#cipher-code-textarea').val();
				$('#cipher-code-textarea').val(cipherText.replaceAll($('#replace1').val(), $('#replace2').val()));
			}

			decodeProcess = (key1, key2, ct) => {
				key1 = key1.trim().replaceAll('  ', ' ').split(' ');
				key2 = key2.trim().replaceAll('  ', ' ').split(' ');
				const keyLen = key1.length;
				const cipherText = ct || $('#cipher-code-textarea').val();
				let plainText = '';
				for(let i = 0; i < cipherText.length;) { // TODO: AC automaton instead of brute force
					let match = -1;
					for(let j = 0; j < keyLen; j++) {
						if(cipherText.startsWith(key1[j], i)) {
							if(match == -1) {
								match = j;
								continue;
							}
							if(key1[match].length < key1[j].length) {
								match = j;
							}
						}
					}
					if(match == -1) {
						plainText += cipherText[i];
						i++;
					} else {
						i += key1[match].length;
						plainText += key2[match] + ' ';
					}
				}
				return plainText;
				$('#plain-code-area').html(`<div style="display:flex;">结果: ${plainText}</div>`);
			}

			const decode = () => {
				const key = $("#key-textarea").val().split('\n');
				$('#plain-code-area').html(`<div style="display:flex;">结果: ${decodeProcess(key[1], key[0])}</div>`);
			}

			const encode = () => {
				const key = $("#key-textarea").val().split('\n');
				$('#plain-code-area').html(`<div style="display:flex;">结果: ${decodeProcess(key[0], key[1])}</div>`);
			}

			const substitutionTable = [
				'q w e r t y u i o p a s d f g h j k l z x c v b n m',
				'a b c d e f g h i j k l m n o p q r s t u v w x y z',
				'11 12 13 14 15 21 22 23 24 24 25 31 32 33 34 35 41 42 43 44 45 51 52 53 54 55',
				'21 22 23 31 32 33 41 42 43 51 52 53 61 62 63 71 72 73 74 81 82 83 91 92 93 94',
				'1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26',
				'01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26',
				'0 1 2 3 4 5 6 7 8 9',
				'.- -... -.-. -.. . ..-. --. .... .. .--- -.- .-.. -- -. --- .--. --.- .-. ... - ..- ...- .-- -..- -.-- --..',
				'----- .---- ..--- ...-- ....- ..... -.... --... ---.. ----.',
				'h he li be b c n o f ne na mg al si p s cl ar k ca sc ti v cr mn fe co ni cu zn ga ge as se br kr rb sr y zr nb mo tc ru rh pd ag cd in sn sb te i xe cs ba la ce pr nd pm sm eu gd tb dy ho er tm yb lu hf ta w re os ir pt au hg tl pb bi po at rn fr ra ac th pa u np pu am cm bk cf es fm md no lr rf db sg bh hs mt ds rg cn uut fl uup lv uus uuo',
				'⠁ ⠃ ⠉ ⠙ ⠑ ⠋ ⠛ ⠓ ⠊ ⠚ ⠅ ⠇ ⠍ ⠝ ⠕ ⠏ ⠟ ⠗ ⠎ ⠞ ⠥ ⠧ ⠺ ⠭ ⠽ ⠵',
			];


			const useMethod = (method) => {
				let str = '';
				switch(method) {
				case 0:
					str += substitutionTable[1] + '\n' + substitutionTable[4];
					break;
				case 1:
					str += substitutionTable[1] + '\n' + substitutionTable[5];
					break;
				case 2:
					str += substitutionTable[1] + '\n' + substitutionTable[0];
					break;
				case 3:
					str += substitutionTable[1] + '\n' + substitutionTable[1].split('').reverse().join('');
					break;
				case 4:
					str += substitutionTable[1] + '\n' + substitutionTable[2];
					break;
				case 5:
					str += substitutionTable[1] + '\n' + substitutionTable[3];
					break;
				case 6:
					str += substitutionTable[1] + ' ' + substitutionTable[6] + '\n' + substitutionTable[7] + ' ' + substitutionTable[8];
					break;
				case 7:
					let numbers = "1";
					for(let i = 2; i <= 118; i++) {
						numbers += ' ' + i.toString();
					}
					str += numbers + '\n' + substitutionTable[9];
					break;
				case 8:
					str += substitutionTable[1] + '\n' + substitutionTable[10];
					break;
				}
				return str;
			}
			
			const changeSubstitutionMethod = () => {
				const methodIndex = $("#substitution-cipher-method")[0].selectedIndex;
				$('#key-textarea').val(useMethod(methodIndex));

			}
			changeSubstitutionMethod();

			const onTypePlainCode = (e) => {
				const isAutoDecode = $('#autoDecode').get(0).checked;
				if(!isAutoDecode)return;
				caeserProcess();
				let pt = substituteCipher($("#cipher-code-textarea").val(), makeMap(substitutionTable[0]));
				$('#plain-code-area').append(`<div style="display:flex;"><div>QWE加密： </div><div>${pt}</div></div>`);

				pt = substituteCipher($("#cipher-code-textarea").val(), makeMap(substitutionTable[1]));
				$('#plain-code-area').append(`<div style="display:flex;"><div>QWE解密： </div><div>${pt}</div></div>`);

				pt = substituteCipher($("#cipher-code-textarea").val(), makeMap(substitutionTable[2]));
				$('#plain-code-area').append(`<div style="display:flex;"><div>Atbash： </div><div>${pt}</div></div>`);
			}

			$('#substitution-cipher-method').ready(() => {
				$('#key-textarea').val(useMethod(0));
			});

			const substituteCipher = (str, mapT) => {
				let mappingTable = mapT
				if(!mapT) {
					mappingTable = $.map($(".map-unit #cipher-text"), (element, i) => 
						{
							const pt = element.dataset.pt;
							const ret = {};
							ret[pt] = element.value;
							return ret;
						}
					).reduce((pre, cur) => {
						return Object.assign(pre, cur);
					});
				}

				let ans = "";
				for(let ch of str) {
					if(mappingTable[ch]) {
						ans += mappingTable[ch];
					} else if(mappingTable[ch.toLowerCase()]) {
						ans += mappingTable[ch.toLowerCase()];
					} else {
						ans += ch;
					}
				}
				return ans;
			}

			const solveGeneralSubstitution = () => {
				const cipherCode = $("#cipher-code-textarea").val();
				$('#plain-code-area').empty();
				const pt = substituteCipher(cipherCode);
				$('#plain-code-area').append(`<div style="display:flex;"><div>结果: </div><div>${pt}</div></div>`);
			}

			const autoCheckClick = (e) => {
				const isAutoDecode = $('#autoDecode').get(0).checked;
				if(isAutoDecode) {
					$('#cipher-code-textarea')[0].style.borderColor = 'red';
					caeserProcess();
					substituteCipher($("#cipher-code-textarea").val(), makeMap(substitutionTable[0]));

				} else {
					$('#cipher-code-textarea')[0].style.borderColor = '';
				}
			}
		// sudoku
		let n = parseInt($("#sudoku-row").html());
		let m = parseInt($("#sudoku-col").html());

		const updateRule = (replaceStr, text, replacedContent) => {
			const findStr = "^" + replaceStr.replace(replacedContent, ".*") + "$";
			const rulesStr = $('#rules').val().split('\n');
			let content = "";
			for(let i = 0; i < rulesStr.length; i++) {
				rulesWithoutSpace = rulesStr[i].replace(/\s/g, '');
				if(rulesWithoutSpace === "")continue;
				if(new RegExp(findStr.replace("[", "\\[").replace(']', "\\]")).test(rulesWithoutSpace)) {
					continue;
				}
				content += `${rulesWithoutSpace}\n`;
			}
			if(text != '') {
				content += replaceStr.replace(replacedContent, text) + `\n`;
			}
			$('#rules').val(content);
		}
		const generate = (n, m) => {
			$('#sudokuContainer').html("");
			$('#sudokuContainer').width(m*30 - m);
			$('#sudokuContainer').height(n*30 + n);
			for(let i = 0; i < n*m; i++) {
				$('#sudokuContainer').append(`<div class="sudoku-grid"><div class="sudoku-index">${i+1}</div><div id="grid-${i}" class="sudoku-grid-content" contenteditable="true"></div></div>`);
			}
			$('.sudoku-grid-content,#sudoku-row,#sudoku-col').on('focus', function() {
				before = $(this).html();
			}).on('blur keyup paste', function() { 
				if (before != $(this).html()) { before = $(this).html(); $(this).trigger('change'); }
			});

			$('.sudoku-grid-content').on('change', (e) =>{
				console.info(e.target.innerText);
				const text = e.target.innerText;
				const number = parseInt(e.currentTarget.id.substr(5)) + 1;
				console.info(number);
				const replaceStr = $("#replaceStr").val().replace("<格子序号>", number.toString());
				updateRule(replaceStr, text, "<格子内容>");
			});

		}

		const initSudoku = () => {
			let initStr = '每一格是从1到9的数字\n每一行互不相同\n每一列互不相同\n第[1,2,3,10,11,12,19,20,21]格互不相同\n第[4,5,6,13,14,15,22,23,24]格互不相同\n第[7,8,9,16,17,18,25,26,27]格互不相同\n';
			initStr += '第[28,29,30,37,38,39,46,47,48]格互不相同\n第[31,32,33,40,41,42,49,50,51]格互不相同\n第[34,35,36,43,44,45,52,53,54]格互不相同\n';
			initStr += '第[55,56,57,64,65,66,73,74,75]格互不相同\n第[58,59,60,67,68,69,76,77,78]格互不相同\n第[61,62,63,70,71,72,79,80,81]格互不相同\n第1格大于5\n';
			$('#replaceStr').val("第<格子序号>格是<格子内容>");
			n = 9;
			m = 9;
			$("#rules").val(initStr);
			$("#sudoku-row").html(n);
			$("#sudoku-col").html(m);
			generate(n, m);
		}

		const changeSolverMode = () => {
			const modeStr = $("#solverMode").val();
			$('#dropHelper').css("display", "none");
			if($('#show-upper').get(0).checked) {
				$('#show-upper').click();
			}
			if($('#show-left').get(0).checked) {
				$('#show-left').click();
			}
			if(modeStr === "sudoku") {
				initSudoku();
			} else if (modeStr === "mine") {
				$('#replaceStr').val("第<格子序号>格的[本格,上,下,左,右,左上,右上,左下,右下]的黑格的数量是<格子内容>");
				$("#rules").val('每一格是白格或黑格\n没填的格子默认是"第<格子序号>格的[本格,上,下,左,右,左上,右上,左下,右下]的黑格的数量是0"\n');
			} else if (modeStr === "magicSquare") {
				let initStr = '每一格是从1到16的数字\n每一格互不相同\n每一列的和是34\n每一行的和是34\n';
				$("#rules").val(initStr);
				n = 4;
				m = 4;
				$("#sudoku-row").html(n);
				$("#sudoku-col").html(m);
				$('#replaceStr').val("第<格子序号>格是<格子内容>");
				generate(n, m);
			} else if (modeStr === "nonogram") {
				if(!$('#show-upper').get(0).checked) {
					$('#show-upper').click();
				}
				if(!$('#show-left').get(0).checked) {
					$('#show-left').click();
				}
				$('#upReplaceStr').val("第<列号>列从上到下连续的黑格长度是[<列序列内容>]");
				$('#leftReplaceStr').val("第<行号>行从左到右连续的黑格长度是[<行序列内容>]");
				let content = "每一格是黑格或白格\n";
				for(let i = 1; i <= n; i++) {
					content += `第${i}行从左到右连续的黑格长度是[0]\n`;
				}
				for(let i = 1; i <= m; i++) {
					content += `第${i}列从上到下连续的黑格长度是[0]\n`;
				}
				$("#rules").val(content);
			} else if (modeStr === "drop") {
				$('#dropHelper').css("display", "unset");
				$('#replaceStr').val("第<格子序号>格强制是黑格");
				$('#upReplaceStr').val("第<列号>列除了黑格外的格子是[<列序列内容>]的一个排列");
				let content = "每一格是从a到z的字母\n第5格强制是黑格\n第10格强制是黑格\n第15格强制是黑格\n第23格强制是黑格\n第28格强制是黑格\n第33格强制是黑格\n第37格强制是黑格\n第43格强制是黑格\n第46格强制是黑格\n第1列除了黑格外的格子是[i,h,t,b,e]的一个排列\n第2列除了黑格外的格子是[o,h,c,n,y]的一个排列\n第3列除了黑格外的格子是[i,l]的一个排列\n第4列除了黑格外的格子是[s,t,i,e,d]的一个排列\n第5列除了黑格外的格子是[h,s,v]的一个排列\n第6列除了黑格外的格子是[l,e,e,o]的一个排列\n第7列除了黑格外的格子是[u,g,n,n]的一个排列\n第8列除了黑格外的格子是[t,o,m,l]的一个排列\n第9列除了黑格外的格子是[o,l,u,n,w]的一个排列\n第10列除了黑格外的格子是[a,s,h,e]的一个排列\n第[1,2,3,4]格按顺序组成单词\n第[6,7,8,9]格按顺序组成单词\n第[11,12,13,14]格按顺序组成单词\n第[16,17,18,19,20,21,22]格按顺序组成单词\n第[24,25,26,27]格按顺序组成单词\n第[29,30,31,32]格按顺序组成单词\n第[34,35,36]格按顺序组成单词\n第[38,39,40,41,42]格按顺序组成单词\n第[44,45]格按顺序组成单词\n第[47,48,49,50]格按顺序组成单词\n";
				n = 5;
				m = 10;
				$("#sudoku-row").html(n);
				$("#sudoku-col").html(m);
				$("#rules").val(content);
				generate(n, m);
				if(!$('#show-upper').get(0).checked) {
					$('#show-upper').click();
				}
			} else if (modeStr === 'simpLoop') {
				let rule = "";
				const black = [1,18,86,154,155,222,38,123,125,91,159,260,8,59,144,195,61,112,146,197,231,282,199,63,46,32,51,68,136,286,237,220,133,99,167];
				for(const grid of black) {
					rule += `第${grid}格是黑格\n`;
				}
				rule += '每一格空白的格子可以形成1条回路\n';
				$("#rules").val(rule);
				n = 17;
				m = 17;
				$("#sudoku-row").html(n);
				$("#sudoku-col").html(m);
				generate(n, m);
			} else if (modeStr === 'hashi') {
				n = 9;
				m = 9;
				$("#sudoku-row").html(n);
				$("#sudoku-col").html(m);
				generate(n, m);
				$("#rules").val("第1格连出的线段总数为3,上下左右线段数量不超过[2,2,2,2]\n第3格连出的线段总数为3,上下左右线段数量不超过[2,2,2,2]\n第73格连出的线段总数为4,上下左右线段数量不超过[2,2,2,2]\n第30格连出的线段总数为4,上下左右线段数量不超过[2,2,2,2]\n第57格连出的线段总数为1,上下左右线段数量不超过[2,2,2,2]\n第49格连出的线段总数为4,上下左右线段数量不超过[2,2,2,2]\n第51格连出的线段总数为2,上下左右线段数量不超过[2,2,2,2]\n第81格连出的线段总数为4,上下左右线段数量不超过[2,2,2,2]\n第36格连出的线段总数为4,上下左右线段数量不超过[2,2,2,2]\n第6格连出的线段总数为1,上下左右线段数量不超过[2,2,2,2]\n第76格连出的线段总数为6,上下左右线段数量不超过[2,2,2,2]\n线段之间互不相交\n");
				$('#replaceStr').val("第<格子序号>格连出的线段总数为<格子内容>,上下左右线段数量不超过[2,2,2,2]");
			}
		}

		$('#dropHelper').click(() => {
			const rules = $('#rules').val().split('\n');
			const blackGrid = new Set();
			for(const rule of rules) {
				if(/^第\d+格.*是黑格$/.test(rule)) {
					blackGrid.add(parseInt(rule.match(/\d+/)[0]));
				}
			}
			let str = "";
			let append = "";
			for(let i = 1; i <= n*m+1; i++) {
				if(blackGrid.has(i) || i == n*m+1) {
					if(str == "")continue;
					append += `第[${str}]格按顺序组成单词\n`;
					str = "";
				} else {
					if(str == "") str = i.toString();
					else
					str += ',' + i.toString();
				}
			}
			$('#rules').val($('#rules').val() + "\n" + append);
		})

		$('#solveSudoku').click(async () => {
			function sleep(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			}
			n = parseInt($("#sudoku-row").html());
			m = parseInt($("#sudoku-col").html());
			const solver = new Solver.SudokuSolver();
			await solver.solve(($('#rules').val().split('\n')), n, m, async ()=>{
				console.info("wtf");
				await sleep(2);
			});
		});

		let sudokuColumnArea = [];
		let sudokuRowArea = [];

		const sudokuChangeInput = (e) => {
			const value = parseInt(e.target.innerText);
			const data = e.target.dataset;
			const index = parseInt(data.idx);
			const column = parseInt(data.col);
			const row = parseInt(data.row);
			const line = data.type === "row" ? $("#sudoku-left #row-"+row).children() : $("#sudoku-upper #col-"+column).children();
			if(data && value !== "") {
				if(data.type === "col" && (index+1 === line.length)) {
					$(`#sudoku-upper #col-${data.col}`).prepend(`<div id="col-cell-${data.col}-${index+1}" data-type="col" data-col=${data.col} data-idx=${index+1} contenteditable="true" oninput="sudokuChangeInput(event)" class="col-input">0</div>`);
				}
				else if(data.type === "row" && (index+1 === line.length)) {
					$(`#sudoku-left #row-${data.row}`).prepend(`<div id="row-cell-${data.row}-${index+1}" data-type="row" data-row=${data.row} data-idx=${index+1} contenteditable="true" oninput="sudokuChangeInput(event)" class="row-input">0</div>`);
				}

			} else {
				if(data.type === "row") {
					while(sudokuRowArea[row].length > index) {
						$(`#sudoku-upper #row-${data.row}`).children().eq(0).remove();
					}
				} else {
					while(sudokuColumnArea[column].length > index) {
						$(`#sudoku-upper #col-${data.col}`).children().eq(0).remove();
					}
				}
			}
			var rule;
			if(data.type === "row") {
				let values = "";
				for(var i = 0; i < line.length; i++) {
					const cell = line[i];
					const cellData = cell.dataset;
					const cellValue = cell.innerText;
					if(cellValue === "0")continue;
					if(values === "") {
						values = cellValue;
					} else {
						values += "," + cellValue;
					}
				}
				rule = $("#leftReplaceStr").val().replace("<行号>", row+1);
				updateRule(rule, values, "<行序列内容>");
			} else {
				let values = "";
				for(var i = 0; i < line.length; i++) {
					const cell = line[i];
					const cellData = cell.dataset;
					const cellValue = cell.innerText;
					if(cellValue === "0")continue;
					if(values === "") {
						values = cellValue;
					} else {
						values += "," + cellValue;
					}
				}
				rule = $("#upReplaceStr").val().replace("<列号>", column+1);
				updateRule(rule, values, "<列序列内容>");
			}
		}

		const showUpper = () => {
			sudokuColumnArea = [];
			for(let i = 0; i < m; i++) {
				sudokuColumnArea.push([]);
			}
			$("#sudoku-upper").html('')
			for(var i = 0; i < m; i++) {
				$("#sudoku-upper").append(`<div id="col-${i}" class="col-container"></div>`);
				$(`#sudoku-upper #col-${i}`).append(`<div id="col-cell-${i}-0" data-type="col" data-col=${i} data-idx=0 contenteditable="true" oninput="sudokuChangeInput(event)" class="col-input">0</div>`);
			}
			$('#upperRules').css("display", "unset");
		}
		$('#show-upper').change(async () => {
			const checked = $('#show-upper').get(0).checked;
			if(checked) {
				showUpper();
			} else {
				$("#sudoku-upper").html('');
				$('#upperRules').css("display", "none");
			}
		});

		const showLeft = () => {
			sudokuRowArea = [];
			for(let i = 0; i < m; i++) {
				sudokuRowArea.push([]);
			}

			$("#sudoku-left").html('')
			for(var i = 0; i < n; i++) {
				$("#sudoku-left").append(`<div id="row-${i}" class="row-container"></div>`);
				$(`#sudoku-left #row-${i}`).append(`<div id="row-cell-${i}-0" data-type="row" data-row=${i} data-idx=0 contenteditable="true" oninput="sudokuChangeInput(event)" class="row-input">0</div>`);
			}
			$('#leftRules').css("display", "unset");
		}

		$('#show-left').change(async () => {
			const checked = $('#show-left').get(0).checked;
			if(checked) {
				showLeft();
			} else {
				$("#sudoku-left").html('');
				$('#leftRules').css("display", "none");
			}
		});

		initSudoku();

		$('#sudoku-col,#sudoku-row').on('change', (e) =>{
			n = parseInt($("#sudoku-row").html());
			m = parseInt($("#sudoku-col").html());
			if($('#show-left').get(0).checked) {
				showLeft();
			}
			if($('#show-upper').get(0).checked) {
				showUpper();
			}
			generate(n,m);
		});

// audio

function Complex(re, im) {
    this.re = re;
    this.im = im || 0.0;
}
Complex.prototype.add = function (other, dst) {
    dst.re = this.re + other.re;
    dst.im = this.im + other.im;
    return dst;
}
Complex.prototype.sub = function (other, dst) {
    dst.re = this.re - other.re;
    dst.im = this.im - other.im;
    return dst;
}
Complex.prototype.mul = function (other, dst) {
    //cache re in case dst === this
    var r = this.re * other.re - this.im * other.im;
    dst.im = this.re * other.im + this.im * other.re;
    dst.re = r;
    return dst;
}
Complex.prototype.cexp = function (dst) {
    var er = Math.exp(this.re);
    dst.re = er * Math.cos(this.im);
    dst.im = er * Math.sin(this.im);
    return dst;
}

Complex.prototype.magnitude = function () {
    return Math.sqrt(this.re * this.re + this.im * this.im);
}
const changeLineType = () => {
	const isSingleLine = $('#singleLine').get(0).checked;
	if(isSingleLine) {
		$("#selectedArea").css("display", "none");
		$("#end").css("display", "none");
	} else {
		$("#selectedArea").css("display", "unset");
		$("#end").css("display", "unset");
	}
}

const Note = [
	["C0",16.35],
	["C#0/Db0",17.32],
	["D0",18.35],
	["D#0/Eb0",19.45],
	["E0",20.60],
	["F0",21.83],
	["F#0/Gb0",23.12],
	["G0",24.50],
	["G#0/Ab0",25.96],
	["A0",27.50],
	["A#0/Bb0",29.14],
	["B0",30.87],
	["C1",32.70],
	["C#1/Db1",34.65],
	["D1",36.71],
	["D#1/Eb1",38.89],
	["E1",41.20],
	["F1",43.65],
	["F#1/Gb1",46.25],
	["G1",49.00],
	["G#1/Ab1",51.91],
	["A1",55.00],
	["A#1/Bb1",58.27],
	["B1",61.74],
	["C2",65.41],
	["C#2/Db2",69.30],
	["D2",73.42],
	["D#2/Eb2",77.78],
	["E2",82.41],
	["F2",87.31],
	["F#2/Gb2",92.50],
	["G2",98.00],
	["G#2/Ab2",103.83],
	["A2",110.00],
	["A#2/Bb2",116.54],
	["B2",123.47],
	["C3",130.81],
	["C#3/Db3",138.59],
	["D3",146.83],
	["D#3/Eb3",155.56],
	["E3",164.81],
	["F3",174.61],
	["F#3/Gb3",185.00],
	["G3",196.00],
	["G#3/Ab3",207.65],
	["A3",220.00],
	["A#3/Bb3",233.08],
	["B3",246.94],
	["C4",261.63],
	["C#4/Db4",277.18],
	["D4",293.66],
	["D#4/Eb4",311.13],
	["E4",329.63],
	["F4",349.23],
	["F#4/Gb4",369.99],
	["G4",392.00],
	["G#4/Ab4",415.30],
	["A4",440.00],
	["A#4/Bb4",466.16],
	["B4",493.88],
	["C5",523.25],
	["C#5/Db5",554.37],
	["D5",587.33],
	["D#5/Eb5",622.25],
	["E5",659.25],
	["F5",698.46],
	["F#5/Gb5",739.99],
	["G5",783.99],
	["G#5/Ab5",830.61],
	["A5",880.00],
	["A#5/Bb5",932.33],
	["B5",987.77],
	["C6",1046.50],
	["C#6/Db6",1108.73],
	["D6",1174.66],
	["D#6/Eb6",1244.51],
	["E6",1318.51],
	["F6",1396.91],
	["F#6/Gb6",1479.98],
	["G6",1567.98],
	["G#6/Ab6",1661.22],
	["A6",1760.00],
	["A#6/Bb6",1864.66],
	["B6",1975.53],
	["C7",2093.00],
	["C#7/Db7",2217.46],
	["D7",2349.32],
	["D#7/Eb7",2489.02],
	["E7",2637.02],
	["F7",2793.83],
	["F#7/Gb7",2959.96],
	["G7",3135.96],
	["G#7/Ab7",3322.44],
	["A7",3520.00],
	["A#7/Bb7",3729.31],
	["B7",3951.07],
	["C8",4186.01],
	["C#8/Db8",4434.92],
	["D8",4698.63],
	["D#8/Eb8",4978.03],
	["E8",5274.04],
	["F8",5587.65],
	["F#8/Gb8",5919.91],
	["G8",6271.93],
	["G#8/Ab8",6644.88],
	["A8",7040.00],
	["A#8/Bb8",7458.62],
	["B8",7902.13]
]

const fft = (amplitudes) => {
	var N = amplitudes.length;
	if (N <= 1)
		return amplitudes;

	var hN = N / 2;
	var even = [];
	var odd = [];
	even.length = hN;
	odd.length = hN;
	for (var i = 0; i < hN; ++i) {
		even[i] = amplitudes[i * 2];
		odd[i] = amplitudes[i * 2 + 1];
	}
	even = fft(even);
	odd = fft(odd);

	var a = -2 * Math.PI;
	for (var k = 0; k < hN; ++k) {
		if (!(even[k] instanceof Complex))
			even[k] = new Complex(even[k], 0);
		if (!(odd[k] instanceof Complex))
			odd[k] = new Complex(odd[k], 0);
		var p = k / N;
		var t = new Complex(0, a * p);
		t.cexp(t).mul(odd[k], t);
		amplitudes[k] = even[k].add(t, odd[k]);
		amplitudes[k + hN] = even[k].sub(t, even[k]);
	}
	return amplitudes;
}

window.AudioContext = window.AudioContext || window.webkitAudioContext;
var source;

function drawBuffer( width, height, context, buffer ) {
    var data = buffer.getChannelData( 0 );
    var step = Math.ceil( data.length / width );
    var amp = 600;
	context.lineWidth = 0.5;
	context.lineJoin = "round";
    context.lineCap = "round";
    for(var i=0; i < width; i++){
        var min = 1.0;
        var max = -1.0;
        for (var j=0; j<step; j++) {
            var datum = data[(i*step)+j]; 
            if (datum < min)
                min = datum;
            if (datum > max)
                max = datum;
        }

		context.beginPath();
		context.moveTo(i+0.5, (1+min)*amp-500);
		context.lineTo(i+0.5, Math.max(1,(max-min)*amp)+(1+min)*amp-500);
		context.stroke();
    }
}
let data;
let sampleRate;


const drawFrequency = (freq) => {
	$("#frequency").empty();
	let noteIndex = 0;
	const note = [];
	for(let i = 0; i < 2000; i++) {
		while(1) {
			if(Math.abs(i*apart+apart/2 - Note[noteIndex+1][1]) < Math.abs(i*apart+apart/2 - Note[noteIndex][1])) {
				noteIndex++;
			} else {
				break;
			}
		}
		note.push(noteIndex);
		$("#frequency").append(`<div class='bar noteTooltip' style="height: ${freq[i]*5}px;"><span class="tooltiptext">${i*apart} ~ ${(i+1)*apart}Hz ${Note[noteIndex][0]}</span></div>`);
		freq[i] = [freq[i], noteIndex];
	}
	freq = freq.sort((x, y) => {return - x[0] + y[0]}).slice(0, 10).sort((x, y) => {return x[1] - y[1]}).map((x)=> {return Note[x[1]][0];});
	let output = "";
	for(let i = 0, j = -1; i < 10; i++) {
		if(freq[i]===freq[j])continue;
		j = i;
		output += freq[i] + " ";
	}
	$("#noteOutput").html(output);	
}

const analysis = () => {
	const startL = parseInt($("#start").css("left"));
	const endL = parseInt($("#end").css("left"));

	$("#end").css("left", $("#start").css("left"));
	$("#selectedArea").css("width", 0);
	
	const leftLine = Math.min(startL, endL);
	const rightLine = Math.max(startL, endL);

	apart = sampleRate / 16384;
	const start = parseInt(leftLine/1000*data.length);
	let ret = [];
	for(let i = start; i < start+16384; i++) {
		ret.push(data[i]*(0.54 - (0.46 * Math.cos(2.0 * Math.PI * (i / ((16384 - 1) * 1.0))))));
	}
	let temp = fft(ret);
	const len = temp.length / 2;
	ret = [];

	temp = temp.slice(0, len);

	for(let i = 0; i < len; i++) {
		temp[i] = temp[i].magnitude();
		if(temp[i][0] > 35) {
			ret.push([(i)*apart,i,temp[i][0]]);
		}
	}

	drawFrequency(temp);
}

let g_buf;
function playAudio(arraybuffer) {
    var context = new window.AudioContext();
    context.decodeAudioData(arraybuffer, function (buf) {
        g_buf = buf;
        var canvas = document.getElementById("wave");
        drawBuffer( canvas.width, canvas.height, canvas.getContext('2d'), buf );
		data = buf.getChannelData( 0 );
		sampleRate = buf.sampleRate;
    });
}

function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    playFile(files[0]);
}

function playFile(file) {
    var freader = new FileReader();

    freader.onload = function (e) {
        console.log(e.target.result);
        playAudio(e.target.result);
    };
    freader.readAsArrayBuffer(file);
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);


$(".line").mousedown((e)=> {
	const left = e.clientX;
	const offset = e.target.parentElement.offsetLeft;
	$(e.target).css("left", left-offset);
	let movable = true;
	const line = $(e.target);
	$(window).mousemove((e)=> {
		if(movable===false)return;
		const startL = parseInt($("#start").css("left"));
		const endL = parseInt($("#end").css("left"));
		
		const leftLine = Math.min(startL, endL);
		const rightLine = Math.max(startL, endL);
		const leftMost = Math.min(e.clientX-offset, leftLine);
		line.css("left", e.clientX-offset);
		$("#selectedArea").css("left", leftMost);
		const selectedWidth = rightLine-leftLine;
		$("#selectedArea").css("width", selectedWidth);
	});
	$(window).mouseup((e)=> {
		movable = false;
	});
})

let analyser;
let tmp = 0;
let apart;

let audioBufferSourceNode;
var start = function() {
	const startL = parseInt($("#start").css("left"));
	const endL = parseInt($("#end").css("left"));

	const leftLine = Math.min(startL, endL);
	const rightLine = Math.max(startL, endL);

  buffer = g_buf;
  if(audioBufferSourceNode) {
      audioBufferSourceNode.stop();
  }
  const audioContext = new AudioContext({
      sampleRate: 44100,
  });
  const l = leftLine*startL;
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 16384;
  apart = 44100 / analyser.fftSize;
  
  audioBufferSourceNode = audioContext.createBufferSource();
  audioBufferSourceNode.connect(analyser);
  analyser.connect(audioContext.destination);
  audioBufferSourceNode.buffer = buffer;

  const total = $("#waveContainer").width();

  const start = audioBufferSourceNode.buffer.duration / total * leftLine;
  const length = audioBufferSourceNode.buffer.duration / total * (rightLine-leftLine);
  audioBufferSourceNode.start(audioContext.currentTime, start, length);
}

$("#play").click(() => {
    start();
});

// smart analysis
let analysisIndex = 0;
const morseAnalysis = (result, words, chars) => {
	result.append(`<h4 class="analysis-hint">尝试莫斯</h4>`);
	result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
	let pt = "";
	const morse = useMethod(6).split('\n');
	for(const word of words) {
		const c = decodeProcess(morse[1], morse[0], word.replaceAll(chars[0], '.').replaceAll(chars[1], '-')).trim();
		if(c.length > 1) {
			pt += '*';
			continue;
		}
		pt += c;
	}
	$(`#analysis-bar-${analysisIndex-1}`).append(`<div><b>${chars[0]}为点, ${chars[1]}为长:</b> ${pt}</div>`);

	pt = "";
	for(const word of words) {
		const c = decodeProcess(morse[1], morse[0], word.replaceAll(chars[1], '.').replaceAll(chars[0], '-')).trim();
		if(c.length > 1) {
			pt += '*';
			continue;
		}
		pt += c;
	}
	$(`#analysis-bar-${analysisIndex-1}`).append(`<div><b>${chars[1]}为点, ${chars[0]}为长:</b> ${pt}</div>`);
}


let folderStatus = false;

const systemAnalysis = (result, nums, row) => {
	const alphabet = substitutionTable[1].split(" ");
	result.append(`<button id="systemCheck">尝试2-36进制转10进制 +</button>`);
	result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar folder" style="${folderStatus?"":"display: none"};"></div>`);
	$(`#systemCheck`).click(()=>{
		console.info("a");
		if(folderStatus){
			$(".folder")[0].style.display = "none";
		}else{
			$(".folder")[0].style.display = "block";
		}
		folderStatus = !folderStatus;
	});
	console.info("b");

	let u = 2;
	for(let i = 25, j = 36; i >= 0; i--, j--) {
		if(row.includes(alphabet[i])) {
			u = j;
			break;
		}
	}
	if(u==2)for(let i = 9; i >= 2; i--) {
		if(row.includes(i)) {
			u = i+1;
			break;
		}
	}
	const numResult = $(`#analysis-bar-${analysisIndex-1}`);
	const special = [2,3,8,16];
	for(let i = u; i <= 36; i++) {
		const numi = nums.map((x)=>parseInt(x, i));
		numResult.append(`<div><b ${special.includes(i)?'style="color: red;"': ""}>${i}进制:</b> ${numi.join(" ")}</div>`);
	}
};

const _roman = { M: 1000, CM: 900, D: 500, CD: 400, C: 100, XC: 90, L: 50, XL: 40, X: 10, IX: 9, V: 5, IV: 4, I: 1 };

const romanize = (number) => {
    return Object.keys(_roman).reduce((acc, key) => {
        while (number >= _roman[key]) {
            acc += key;
            number -= _roman[key];
        }
        return acc;
    }, '');
}



const deromanize = (roman) => {
  const romanNumeralRegex = new RegExp(
    /^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/
  );
  roman = roman.toUpperCase();
  const regexResult = romanNumeralRegex.test(roman);

  if (!regexResult) {
    return false;
  }

  let arr = ["I", "V", "X", "L", "C", "D", "M"];

  let values = {
    I: 1,
    V: 5,
    X: 10,
    L: 50,
    C: 100,
    D: 500,
    M: 1000,
  };

  let sum = 0;

  let prevIndex = 0;

  for (let i = roman.length - 1; i >= 0; i--) {
    if (arr.indexOf(roman[i]) >= prevIndex) {
      sum = sum + values[roman[i]];
    } else {
      sum = sum - values[roman[i]];
    }
    prevIndex = arr.indexOf(roman[i]);
  }

  return sum;
};


const numbersAnalysis = (result, nums, rows) => {
	result.append(`<h4 class="analysis-hint">尝试数字</h4>`);
	result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
	const numResult = $(`#analysis-bar-${analysisIndex-1}`);
	if(nums.filter((x)=>
		x <=0 || x > 26
	).length === 0) {
		numResult.append(`<h4 class="analysis-hint">发现所有数字都在1-26之间</h4>`);
		const answer = nums.map((x)=>String.fromCharCode(x+96)).join("");
		numResult.append(`<div><b>A=1..Z=26:</b> ${answer}</div>`);
	}
	if(nums.filter((x)=>
		x <0 || x >= 26
	).length === 0) {
		numResult.append(`<h4 class="analysis-hint">发现所有数字都在0-25之间</h4>`);
		const answer = nums.map((x)=>String.fromCharCode(x+97)).join("");
		numResult.append(`<div><b>A=0..Z=25:</b> ${answer}</div>`);
	}
	if(nums.filter((x)=>
		x <=0 || x >= 255
	).length === 0) {
		numResult.append(`<h4 class="analysis-hint">发现所有数字都在1-255之间,尝试ASCII码</h4>`);
		const answer = nums.map((x)=>String.fromCharCode(x)).join("");
		numResult.append(`<div><b>ASCII:</b> ${answer}</div>`);
	}

	if(nums.filter((x)=>x >= 118 || x <= 0).length === 0) {
		numResult.append(`<h4 class="analysis-hint">发现所有数字都在1-118之间,尝试元素周期表</h4>`);
		const element = useMethod(7).split('\n');
		let pt = "";
		for(const word of rows) {
			let c = decodeProcess(element[0], element[1], word).trim();
			c = c[0].toUpperCase() + c.slice(1);
			pt += c + " ";
		}
		numResult.append(`<div><b>元素符号:</b> ${pt}</div>`);
	}


	let romanFlag = true;
	let pt = "";
	for(const num of nums) {
		const rnum = romanize(num);
		if(!rnum || num > 3999) {
			romanFlag = false;
			break;
		}
		pt += rnum + " ";
	}
	if(romanFlag) {
		numResult.append(`<div><b>罗马数字:</b> ${pt}</div>`);
	}

	const five = rows.filter((x)=>(x.length == 2) && (parseInt(x[0]) <= 5 && parseInt(x[0]) >= 1) && (parseInt(x[1]) <= 5 && parseInt(x[1]) >= 1));
	if(five.length === rows.length) {
		numResult.append(`<h4 class="analysis-hint">发现所有数字长度都为2,且都在1到5之间，尝试棋盘密码</h4>`);
		const fives = useMethod(4).split('\n');
		let pt = "";
		for(const word of rows) {
			const c = decodeProcess(fives[1], fives[0], word).trim();
			pt += c;
		}
		$(`#analysis-bar-${analysisIndex-1}`).append(`<div><b>5*5棋盘</b> ${pt}</div>`);
	}
}

const summaryAnalysis = (result, str) => {
	result.append(`<h4 class="analysis-hint">综合分析</h4>`);
	result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
	const summaryResult = $(`#analysis-bar-${analysisIndex-1}`);
	summaryResult.append(`<div>共${str.length}个字符, 详细统计</div>`);
	const chars = {};
	for(let i = 0; i < str.length; i++) {
		chars[str[i]] = (chars[str[i]] || 0) + 1;
	}
	const res = Object.entries(chars);
	let s = "";
	for(const entry of res) {
		summaryResult.append(`<div>${entry[0]}: ${entry[1]}</div>`);
	}
}

const binaryAnalysis = (result, words, chars) => {
	let pt = "";
	result.append(`<h4 class="analysis-hint">尝试二进制</h4>`);
	result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
	const binaryResult = $(`#analysis-bar-${analysisIndex-1}`);
	let numbers = [];
	for(const word of words) {
		const number = parseInt(word.replaceAll(chars[0], ' ').replaceAll(chars[1], '0').replaceAll(' ', '1'), 2);
		numbers.push(number);
		pt += number.toString() + " ";
	}

	binaryResult.append(`<div><b>若${chars[0]}为1, ${chars[1]}为0:</b> ${pt}</div>`);

	binaryResult.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);

	numbersAnalysis($(`#analysis-bar-${analysisIndex-1}`), numbers, numbers.map((x)=>x.toString()));

	pt = "";
	numbers = [];
	for(const word of words) {
		const number = parseInt(word.replaceAll(chars[1], ' ').replaceAll(chars[0], '0').replaceAll(' ', '1'), 2);
		numbers.push(number);
		pt += number.toString() + " ";
	}


	binaryResult.append(`<div><b>若${chars[1]}为1, ${chars[0]}为0:</b> ${pt}</div>`);
	binaryResult.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
	numbersAnalysis($(`#analysis-bar-${analysisIndex-1}`), numbers, numbers.map((x)=>x.toString()));
}

const elementsAnalysis = (result, words) => {
	result.append(`<h4 class="analysis-hint">元素序号</h4>`);
	result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
	const elementsResult = $(`#analysis-bar-${analysisIndex-1}`);
	let numbers = [];
	let pt = "";
	const element = useMethod(7).split('\n');
	for(const word of words) {
		const c = decodeProcess(element[1], element[0], word).trim();
		pt += c + " ";
		numbers.push(c);
	}
	elementsResult.append(`<div><b>元素序号:</b> ${pt}</div>`);
	numbersAnalysis(elementsResult, numbers.map(x=>parseInt(x)), numbers);
}

const lettersAnalysis = (result, content, words) => {
	let element = useMethod(0).split('\n');
	result.append(`<div><b>字母序(a = 1, z = 26): </b>${decodeProcess(element[0], element[1], content)}</div>`);
	element = useMethod(2).split('\n');
	result.append(`<div><b>QWE编码(a = q): </b>${words.map((x) => decodeProcess(element[0], element[1], x).replaceAll(" ", "")).join(" ")}</div>`);
	element = useMethod(2).split('\n');
	result.append(`<div><b>QWE解码(q = a): </b>${words.map((x) => decodeProcess(element[1], element[0], x).replaceAll(" ", "")).join(" ")}</div>`);
	element = useMethod(3).split('\n');
	result.append(`<div><b>Atbash: </b>${words.map((x) => decodeProcess(element[0], element[1], x).replaceAll(" ", "")).join(" ")}</div>`);
	element = useMethod(6).split('\n');
	result.append(`<div><b>莫斯编码: </b>${words.map((x) => decodeProcess(element[0], element[1], x)).join(" ")}</div>`);
	element = useMethod(8).split('\n');
	result.append(`<div><b>盲文: </b>${words.map((x) => decodeProcess(element[0], element[1], x).replaceAll(" ", "")).join(" ")}</div>`);
	result.append(`<h4 class="analysis-hint">凯撒移位(暴力)</h4>`);
	result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
	const caeserResult = $(`#analysis-bar-${analysisIndex-1}`);
	for(let i = 1; i < 26; i++) {
		caeserResult.append(`<div><b>移动${i}位: </b> ${caeser(content, i)}</div>`);
	}
	//result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
}


$("#smart-analysis-content").on("keyup paste", () => {
	analysisIndex = 0;
	const result = $("#smart-analysis-ansers-list");
	result.html("");
	const content = $("#smart-analysis-content").val();
	const row = content.trim().toLowerCase();
	const words = row.split(/[\s,]+/);
	const count = {};
	const chars = [];
	let index = 0;
	let countOfChar = 0;
	let isAllnumber = true;
	const cheElement = substitutionTable[9].split(' ');
	let isAllElement = true;
	let isAllLetter = true;
	for(const word of words) {
		for(let i = 0; i < word.length; i++) {
			if(count[word[i]] === undefined) {
				count[word[i]] = 1;
				chars.push(word[i]);
				countOfChar++;
			} else {
				count[word[i]]++;
			}
		}
		if(!/^-?\d+$/.test(word)) {
			isAllnumber = false;
		}
		if(!cheElement.includes(word)) {
			isAllElement = false;
		}

		if((/^[a-zA-Z]*$/.test(word)) === false) {
			isAllLetter = false;
		}
	}
	if(countOfChar <= 2) {
		result.append(`<div class="analysis-hint">只有两个字符, 开始二值分析</div><div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div`);
		const index = analysisIndex-1;
		morseAnalysis($(`#analysis-bar-${index}`), words, chars);
		binaryAnalysis($(`#analysis-bar-${index}`), words, chars);

	}

	if(isAllnumber) {
		numbersAnalysis(result, words.map((x) => parseInt(x)), words);
	}

	if(isAllElement) {
		result.append(`<div class="analysis-hint">全部为元素符号, 开始元素符号分析</div>`);
		result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
		const index = analysisIndex-1;
		elementsAnalysis($(`#analysis-bar-${index}`), words);
	}

	if(isAllLetter) {
		let pt = "";
		let romanFlag = true;
		const numbers = [];
		for(const word of words) {
			const number = deromanize(word);
			if(!number) {
				romanFlag = false;
				break;
			}
			numbers.push(number);
			pt += number.toString() + " ";
		}

		if(romanFlag) {
			result.append(`<div class="analysis-hint">全部为罗马数字</div>`);
			result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
			const index = analysisIndex-1;
			const romanResult = $(`#analysis-bar-${index}`);
			romanResult.append(`<div><b>罗马数字:</b>${pt}</div>`);
			numbersAnalysis(romanResult, numbers, numbers.map(x=>x.toString()));
		}

		result.append(`<div class="analysis-hint">全部为字母, 开始加密分析</div>`);
		result.append(`<div id="analysis-bar-${analysisIndex++}" class="analysis-bar"></div>`);
		const index = analysisIndex-1;
		lettersAnalysis($(`#analysis-bar-${index}`), row, words);
	}

	result.append(`<div><b>倒序:</b>${Array.from(content).reverse().join('')}</div>`);



	systemAnalysis(result, words, row)

	summaryAnalysis(result, content);

});

		</script>
		<script src="./static/dict.v1.0.min.js"></script>
		<script>
			if(!localStorage.abc) {
				for(const obj in words) {localStorage.setItem(obj, words[obj]);}
				solver = new Solver.OneWord();
				$('h3').remove();
			}
		</script>
		<script src="./out.js"></script>
		</div>
	</body>
</html>
